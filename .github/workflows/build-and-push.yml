name: Build and Publish Package to GitHub Packages
on:
  push:
    branches:
      - main
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
        - name: Checkout
          uses: actions/checkout@v2
        - name: Setup Node 20.x
          uses: actions/setup-node@v2
          with:
            node-version: 20.x
            registry-url: 'https://npm.pkg.github.com'

        - name: Log in to GitHub Container Registry
          uses: docker/login-action@v2
          with:
            registry: ghcr.io
            username: ${{ github.actor }}
            password: ${{ secrets.GITHUB_TOKEN }}     

        - id: determine_tag
          uses: ./.github/actions/determine-ta      
        - name: Build Docker image
          run: |
            docker build -f Dockerfile -t ghcr.io/${{ github.repository }}/data-vitae-test:${{ steps.determine_tag.outputs.image_tag }}       
        - name: Push Docker image to GHCR
          run: |
            docker push ghcr.io/${{ github.repository }}/data-vitae-test:${{ steps.determine_tag.outputs.image_tag }}
          
        - name: Git Identity
          run: |
            git config --global user.name 'github-actions[bot]'
            git config --global user.email 'github-actions[bot]@users.noreply.github.com'
            git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/$GITHUB_REPOSITORY
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

        - name: Configure .npmrc for GitHub Packages
          run: |
            echo "//npm.pkg.github.com/:_authToken=${GITHUB_TOKEN}" > .npmrc
            echo "registry=https://npm.pkg.github.com/" >> .npmrc
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


        - name: Install
          run: yarn install
          
        - name: Install Canvas and XML dependencies
          run: sudo apt-get install -y libxml2-utils
          
        - name: Publish
          run: |
            yarn versionup --yes
            yarn release --yes
          env:
            GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}